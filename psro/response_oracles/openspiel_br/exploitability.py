"""Compute exploitability using OpenSpiel."""
import pyspiel
from open_spiel.python.algorithms import exploitability as openspiel_exploitability

from psro import strategy
from psro.response_oracles.openspiel_br import utils


def exploitability(game: pyspiel.Game, players: strategy.JointStrategy):
  """."""
  if game.num_players() != 2:
    raise ValueError("Game must be a 2-player game")
  game_info = game.get_type()
  if game_info.dynamics != pyspiel.GameType.Dynamics.SEQUENTIAL:
    raise ValueError(f"The game must be turn-based, not {game_info.dynamics}")
  if game_info.utility not in (pyspiel.GameType.Utility.ZERO_SUM, pyspiel.GameType.Utility.CONSTANT_SUM):
    raise ValueError(f"The game must be constant- or zero-sum, not {game_info.utility}")

  aggr_policy = utils.aggregate_joint_strategy(game, players)
  return dict(
      enumerate(
          openspiel_exploitability.nash_conv(
              game, aggr_policy, return_only_nash_conv=False, use_cpp_br=True
          ).player_improvements
      )
  )
